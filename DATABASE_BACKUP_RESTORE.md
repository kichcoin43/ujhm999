# Резервное копирование и восстановление базы данных

В этом документе описаны процедуры резервного копирования и восстановления базы данных для приложения BNAL Bank.

## Важная информация

- Приложение использует SQLite для хранения данных
- На Render.com база данных хранится в директории `/data/sqlite.db`
- Резервные копии сохраняются в директории `/data/backup`
- Существует три формата резервных копий: JSON, SQL и ZIP

## Автоматическое резервное копирование

Приложение автоматически создает резервные копии базы данных:

1. При запуске приложения
2. Каждые 24 часа
3. При обновлении важных данных (например, при создании/обновлении пользователей)

Резервные копии хранятся в следующих директориях:
- JSON: `/data/backup/json`
- SQL: `/data/backup/sql`
- ZIP: `/data/backup/zip`

## Ручное резервное копирование

Для ручного создания резервной копии:

1. Войдите в приложение как регулятор (admin)
2. Перейдите на страницу администратора
3. Нажмите кнопку "Создать резервную копию"

Или используйте API (требуется авторизация регулятора):
```
GET /api/backup
```

## Восстановление данных

Для восстановления данных из резервной копии:

1. Войдите в приложение как регулятор (admin)
2. Перейдите на страницу администратора
3. Выберите резервную копию
4. Нажмите кнопку "Восстановить"

Или используйте API (требуется авторизация регулятора):
```
POST /api/restore
```

## Резервное копирование перед деплоем на Render.com

Перед деплоем приложения на Render.com рекомендуется создать резервную копию всей базы данных:

1. Остановите приложение
2. Скопируйте файл `sqlite.db` в безопасное место
3. Запустите скрипт:
```bash
node scripts/backup-app-state.js
```

## Структура резервных копий

### JSON
Содержит все данные из базы данных в формате JSON, что позволяет легко просматривать и редактировать данные.

### SQL
Содержит SQL-запросы для воссоздания всей базы данных. Может быть использован для импорта данных в другую базу данных.

### ZIP
Сжатая резервная копия всей базы данных. Включает в себя и JSON, и SQL копии.

## Проверка резервных копий

Для проверки наличия и целостности резервных копий:

1. Войдите в приложение как регулятор (admin)
2. Перейдите на страницу администратора
3. В разделе "Резервные копии" вы увидите список всех доступных резервных копий

Или на Render.com проверьте содержимое директории `/data/backup`:
```bash
ls -la /data/backup/zip
```

## Восстановление при сбоях

В случае сбоя приложения:

1. Проверьте наличие резервных копий
2. Восстановите последнюю работающую копию
3. Если восстановление через интерфейс невозможно, используйте ручное восстановление:
```bash
cp /data/backup/sqlite.db.backup /data/sqlite.db
```

## Миграция на другой сервер

Для миграции на другой сервер:

1. Создайте полную резервную копию
2. Скопируйте файл `sqlite.db` и директорию `/data/backup` на новый сервер
3. Запустите приложение на новом сервере

## Важные замечания

- Всегда проверяйте целостность резервных копий перед восстановлением
- Храните копии в разных местах для дополнительной безопасности
- При возникновении проблем с базой данных, сначала попробуйте восстановить из резервной копии, прежде чем вносить изменения вручную